name: _Release Browser (Reusable)

on:
  workflow_call:
    inputs:
      channel:
        required: true
        type: string
      new-cycle:
        required: false
        type: boolean
        default: false
    secrets:
      NUCLEO_LICENSE_KEY:
        required: false
      POSTHOG_API_KEY:
        required: false
      VITE_POSTHOG_API_KEY:
        required: false
      APPLE_ID:
        required: false
      APPLE_PASSWORD:
        required: false
      APPLE_TEAM_ID:
        required: false
      MACOS_CERT_P12_BASE64:
        required: false
      MACOS_CERT_P12_PASSWORD:
        required: false

jobs:
  pre-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check CI Status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMIT=$(git rev-parse HEAD)
          # If current commit is a release commit (skipped CI), check parent commit instead
          if git log -1 --format=%s | grep -q "\[skip ci\]"; then
            COMMIT=$(git rev-parse HEAD~1)
            echo "Current commit skipped CI, checking parent: $COMMIT"
          fi
          CI_STATUS=$(gh run list --workflow=monorepo-ci.yml --branch="${GITHUB_REF#refs/heads/}" --limit=10 \
            --json headSha,conclusion --jq ".[] | select(.headSha == \"$COMMIT\") | .conclusion" | head -1)
          if [ "$CI_STATUS" != "success" ]; then
            echo "::error::CI has not passed. Status: ${CI_STATUS:-not found}"
            exit 1
          fi

  version-bump:
    needs: pre-check
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.bump.outputs.version }}
      tag: ${{ steps.bump.outputs.tag }}
      notes: ${{ steps.bump.outputs.notes }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: pnpm/action-setup@v4
        with:
          version: 10.27.0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - name: Bump Version
        id: bump
        run: |
          ARGS="--package stagewise --channel ${{ inputs.channel }}"
          [ "${{ inputs.new-cycle }}" == "true" ] && ARGS="$ARGS --new-cycle"
          pnpm tsx scripts/release/index.ts $ARGS
          echo "version=$(cat .release-version)" >> $GITHUB_OUTPUT
          echo "tag=$(cat .release-tag)" >> $GITHUB_OUTPUT
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat .release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit and Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore(stagewise): release ${{ steps.bump.outputs.version }} [skip ci]"
          git push
          git tag ${{ steps.bump.outputs.tag }}
          git push origin ${{ steps.bump.outputs.tag }}

  build:
    needs: version-bump
    environment: Release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-26
            arch: arm64
            artifact: stagewise-macos-arm64
          - os: ubuntu-latest
            arch: x64
            artifact: stagewise-linux-x64
          - os: windows-latest
            arch: x64
            artifact: stagewise-windows-x64

    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    env:
      NODE_OPTIONS: "--max-old-space-size=8192"
      NUCLEO_LICENSE_KEY: ${{ secrets.NUCLEO_LICENSE_KEY }}
      POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
      VITE_POSTHOG_API_KEY: ${{ secrets.VITE_POSTHOG_API_KEY }}
      API_URL: ${{ vars.API_URL }}
      VITE_API_URL: ${{ vars.VITE_API_URL }}
      STAGEWISE_CONSOLE_URL: ${{ vars.STAGEWISE_CONSOLE_URL }}
      VITE_STAGEWISE_CONSOLE_URL: ${{ vars.VITE_STAGEWISE_CONSOLE_URL }}
      LLM_PROXY_URL: ${{ vars.LLM_PROXY_URL }}
      VITE_DISABLE_TELEMETRY: ${{ vars.VITE_DISABLE_TELEMETRY }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.version-bump.outputs.tag }}

      - uses: pnpm/action-setup@v4
        with:
          version: 10.27.0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - name: Import macOS signing certs
        if: runner.os == 'macOS'
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.MACOS_CERT_P12_BASE64 }}
          p12-password: ${{ secrets.MACOS_CERT_P12_PASSWORD }}

      - run: pnpm build

      - name: Build Electron App
        working-directory: apps/browser
        run: pnpm make --arch=${{ matrix.arch }}
        env:
          BUILD_MODE: production
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          RELEASE_CHANNEL: ${{ inputs.channel == 'release' && 'release' || 'prerelease' }}

      - name: List build output
        working-directory: apps/browser
        run: find out -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.nupkg" -o -name "*.deb" -o -name "*.rpm" \) 2>/dev/null || true
        shell: bash

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            apps/browser/out/*/make/**/*.dmg
            apps/browser/out/*/make/**/*.exe
            apps/browser/out/*/make/**/*.nupkg
            apps/browser/out/*/make/**/*.deb
            apps/browser/out/*/make/**/*.rpm
          if-no-files-found: warn

  release:
    needs: [version-bump, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Rename Artifacts
        run: |
          VERSION="${{ needs.version-bump.outputs.version }}"
          mkdir -p release

          echo "Found artifacts:"
          find artifacts -type f

          # macOS
          find artifacts -name "*.dmg" -exec cp {} "release/stagewise-${VERSION}-macos-arm64.dmg" \;

          # Windows (exe + nupkg for auto-updates)
          find artifacts -name "*.exe" -exec cp {} "release/stagewise-${VERSION}-windows-x64.exe" \;
          find artifacts -name "*.nupkg" -exec cp {} "release/stagewise-${VERSION}-windows-x64.nupkg" \;

          # Linux
          find artifacts -name "*.deb" -exec cp {} "release/stagewise-${VERSION}-linux-x64.deb" \;
          find artifacts -name "*.rpm" -exec cp {} "release/stagewise-${VERSION}-linux-x64.rpm" \;

          echo "Release artifacts:"
          ls -la release/

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version-bump.outputs.tag }}
          name: "Stagewise ${{ needs.version-bump.outputs.version }}"
          body: ${{ needs.version-bump.outputs.notes }}
          prerelease: ${{ inputs.channel != 'release' }}
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
